#!/bin/bash -ex

apt update
apt install -y virt-manager libguestfs-tools
# add user to libvirt group
# usermod -a -G libvirt $(whoami)

systemctl start libvirtd
systemctl enable libvirtd
systemctl status libvirtd


# add virtualnetwork security-network
if ! virsh net-list | grep infosec-net ; then

  cat <<EOF > infosec-net.xml
<network>
  <name>infosec-net</name>
  <uuid>b61773a5-0d63-4415-a922-6caca824f1f7</uuid>
<forward mode='nat'/>
<bridge name='virbr1'/>
  <ip address='192.168.56.101' netmask='255.255.255.0'/>
</network>
EOF

  virsh net-define infosec-net.xml
  virsh net-start infosec-net
  virsh net-autostart infosec-net
  rm infosec-net.xml
else
  echo "virtual network 'infosec-net' already defined, skipping..."
fi

if ! virsh net-info default | grep Active | grep yes ; then
  virsh net-start default
fi
virsh net-autostart default
