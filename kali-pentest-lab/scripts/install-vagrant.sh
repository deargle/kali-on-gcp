#!/bin/bash -ex
if ! which vagrant ; then
  sed -e 's/^# deb-src/deb-src/g' -i /etc/apt/sources.list
  apt update


  # install deps
  apt build-dep -y vagrant ruby-libvirt
  apt install -y  qemu libvirt-daemon-system libvirt-clients ebtables dnsmasq-base
  apt install -y libxslt-dev libxml2-dev libvirt-dev zlib1g-dev ruby-dev

  # https://askubuntu.com/a/1356903/1402015
  VERSION=$(curl -s https://api.github.com/repos/hashicorp/vagrant/tags | jq ".[0].name" | cut -c 3-8)
  PACKAGE_NAME="vagrant_${VERSION}_x86_64.deb"
  curl -O https://releases.hashicorp.com/vagrant/${VERSION}/${PACKAGE_NAME}
  chmod 755 ${PACKAGE_NAME}
  sudo apt install ./${PACKAGE_NAME}
  rm -f ${PACKAGE_NAME}
else
  echo 'vagrant command already available, not installing...'
fi

if ! vagrant plugin list | grep -q vagrant-libvirt ; then
  vagrant plugin install vagrant-libvirt
else
  echo 'vagrant plugin "vagrant-libvirt" already installed, skipping...'
fi

if ! virsh net-list --all | grep vagrant-libvirt ; then

  cat <<EOF > vagrant-libvirt-management-net.xml
  <network ipv6='yes'>
    <name>vagrant-libvirt</name>
    <uuid>0142f149-314f-41be-a587-43fc2548af39</uuid>
    <forward mode='nat'>
      <nat>
        <port start='1024' end='65535'/>
      </nat>
    </forward>
    <bridge name='virbr2' stp='on' delay='0'/>
    <mac address='52:54:00:82:3a:d1'/>
    <ip address='192.168.121.1' netmask='255.255.255.0'>
      <dhcp>
        <range start='192.168.121.1' end='192.168.121.254'/>
      </dhcp>
    </ip>
  </network>
EOF
  virsh net-define vagrant-libvirt-management-net.xml
  rm vagrant-libvirt-management-net.xml
fi

if ! virsh net-info vagrant-libvirt | grep Active | grep yes ; then
  virsh net-start vagrant-libvirt
fi
virsh net-autostart vagrant-libvirt
