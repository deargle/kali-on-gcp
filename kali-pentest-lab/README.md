# Kali Pentest Lab

## To Use:

* install Vagrant
* install [vagrant-google plugin](https://github.com/mitchellh/vagrant-google)
* if not done already, add an ssh key to your project's Metadata area. The
  vagrant-google provider will connect to the launched instance using gcp auth.

* edit the Vagrantfile:

  * set the path to a gcp service keyfile (e.g., `account.json` as in the root dir of this repo). This will give the plugin
    permissions to launch instances in your project.
  * Put the ssh username and private key filename into the Vagrantfile. The plugin
    will connect to the launched instance using these credentials.
      * If the vagrant provision step is asking for a password, then something may be wrong with your keyfile --
        try ssh'ing manually, and look for error messages. e.g.:

            ```
            vagrant ssh-config > ssh.config
            ssh -F ssh.config default
            ```
  * set the path to your ssh private keyfile to your gcp project. Don't put it in this directory, because if
    you do, it will be `rsync`'ed to the guest (to directory `/vagrant`)!

If this image is to become a base image for others to launch, then step down
the disk space and relaunch before creating the image. resizefs should (hopefully)
automatically run on the image as it launches. Then create your image.

Then, run `vagrant up`!

## To prepare as a golden image

* Shut down the instance.

  `vagrant halt`
* Use the GCP console to create a new image from the instance backing disk.
  * Get the "disk" name from the `Disks` console tab. It defaults to be the same
    name as the image it backed. Also get the disk's "zone.""
  * run the following `gcloud` command from a console "cloud shell."

    ```
    gcloud compute images create <new-image-name> \
        --source-disk <source-disk-name> \
        --source-disk-zone <source-disk-zone> \
        --family <family-name>
    ```

    For example:

    ```
    gcloud compute images create kali-v3-0-0 \
        --source-disk kali-v3 \
        --source-disk-zone us-central1-f \
        --family security-assignments-kali
    ```

<https://cloud.google.com/compute/docs/images/image-families-best-practices>



## Extra VMs

### De-ICE VulnHub

To get [De-ICE level 1](https://www.vulnhub.com/entry/de-ice-s1100,8/) onto Kali:

* Create a libirt virtual network with the following config:

        <network connections="1">
          <name>De-ICE</name>
          <uuid>c8b50fe2-876b-439a-9f6c-97d78a5a5dad</uuid>
          <forward mode="nat">
            <nat>
              <port start="1024" end="65535"/>
            </nat>
          </forward>
          <bridge name="virbr3" stp="on" delay="0"/>
          <mac address="52:54:00:2a:33:af"/>
          <domain name="De-ICE"/>
          <ip address="192.168.1.1" netmask="255.255.255.0">
          </ip>
        </network>

* Download the ISO:

    wget http://hackingdojo.com/downloads/iso/De-ICE_S1.100.iso

* Create a new virtual machine in kali. We're only going to use it to boot off of
  the ISO, so doesn't need storage.
    * set to use ISO. Add storage pool and point to De-ICE_S1.100.iso
    * Generic Linux
    * Default cpu and memory
    * Uncheck "Enable storage"
    * Name it something nice
    * Network selection > select your De-ICE network.
    * Finish
* You may need to mount the ISO again, after the first boot.
* Does not respond to ping (icmp). nmap -O 192.168.1.100 to ensure online.


## Changelog

* August 24, 2021
  * Updated to Kali 2021.2
  * All users can do passwordless sudo. I did this because users connecting via
    chrome remote desktop weren't getting added to the `google-sudoers` group,
    even though they do get added when ssh'ing in.

    An alternative would be to have users add themselves to the `kali-trusted` (IIRC)
    group, when ssh'ing in. But really, with a known root password `toor`, in my view
    it's no additional security exposure to give all users passwordless sudo.
  * Pre-install the latest Nessus v8.
  * Install the most recent vagrant version.
  * have the vagrant SO add sleep for 5 min and then halt, instead of requiring
    the user to connect and halt that vm after it finishes its initial boot.
  * Update the chrome remote desktop script to set default xfce.
